{% extends 'base.html' %}
{% block title %}New Booking{% endblock %}

{% block extra_head %}
<style>
  main {
    margin-left: 220px;
    padding: 2rem;
    max-width: 700px;
    background: white;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-radius: 10px;
    margin-top: 1rem;
    margin-bottom: 1rem;
  }
  h2 { text-align: center; margin-bottom: 1.5rem; color: #1f2937; font-weight: 700; }
  label { display: block; margin-top: 15px; font-weight: 600; color: #374151; }
  input, select { width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #d1d5db; border-radius: 6px; }
  .radio-group { margin-top: 15px; }
  .price-info { margin-top: 20px; font-weight: 600; font-size: 1.1rem; color: #2563eb; }
  button { margin-top: 30px; width: 100%; padding: 12px; font-weight: 700; font-size: 1.1rem;
           border: none; border-radius: 6px; cursor: pointer; background-color: #10b981; color: white; }
  button:hover { background-color: #059669; }
  #roomDetails {
    margin-top: 20px; padding: 12px; border: 1px solid #2563eb; border-radius: 6px;
    background: #e0f2fe; color: #1e40af; display: none;
  }
</style>
{% endblock %}

{% block content %}
<h2>New Booking</h2>

<form method="POST" action="{% url 'booking:new_booking' %}">
  {% csrf_token %}

  <label for="id_customer_name">Customer Name</label>
  <input id="id_customer_name" name="customer_name" type="text" required>

  <label for="id_phone_number">Phone Number</label>
  <input id="id_phone_number" name="phone_number" type="text" required>

  <label for="id_address">Address</label>
  <input id="id_address" name="address" type="text">

  <label for="id_document_type">Document Type</label>
  <select id="id_document_type" name="document_type" required>
    <option value="">Select Document</option>
    <option value="Aadhar">Aadhar Number</option>
    <option value="License">Driver's License</option>
    <option value="PAN">PAN Number</option>
  </select>

  <label for="id_document_number">Document Number</label>
  <input id="id_document_number" name="document_number" type="text" required>

  <label for="roomNumber">Room Number (Available Only)</label>
  <select id="roomNumber" name="room" required>
    <option value="">Select Room</option>
    {% for room in rooms %}
      <option value="{{ room.id }}">{{ room.room_number }}</option>
    {% endfor %}
  </select>

  <div id="roomDetails">
    <strong>Room Details:</strong><br>
    Type: <span id="roomType"></span><br>
    AC Type: <span id="acType"></span><br>
    Floor: <span id="floor"></span><br>
    Status: <span id="status"></span><br>
    Price (â‚¹): <span id="roomPrice">0.00</span>
  </div>

  <label for="id_adults">Adults</label>
  <input id="id_adults" name="adults" type="number" min="1" value="1" required>

  <label for="id_children">Children</label>
  <input id="id_children" name="children" type="number" min="0" value="0" required>

  <label for="id_booking_status">Booking Status</label>
  <select id="id_booking_status" name="booking_status" required>
    <option value="booked">Booked</option>
    <option value="prebooked">Pre-Booked</option>
  </select>

  <label for="id_checkin_date">Check-in Date</label>
  <input id="id_checkin_date" name="checkin_date" type="date" required>

  <label for="id_checkout_date">Check-out Date</label>
  <input id="id_checkout_date" name="checkout_date" type="date" required>

  <div class="radio-group">
    <label><strong>Payment Type</strong></label><br>
    <input type="radio" id="id_payment_upi" name="payment_type" value="upi" required>
    <label for="id_payment_upi">UPI</label>

    <input type="radio" id="id_payment_cash" name="payment_type" value="cash" required>
    <label for="id_payment_cash">Cash</label>

    <input type="radio" id="id_payment_card" name="payment_type" value="card" required>
    <label for="id_payment_card">Card</label>
  </div>

  <div class="radio-group">
    <input type="checkbox" id="id_apply_gst" name="apply_gst" value="true">
    <label for="id_apply_gst"><strong>Apply GST (18%)</strong></label>
  </div>

  <button type="submit">Save Booking</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  function updatePrice(basePrice) {
    const gstApplied = $("#id_apply_gst").is(":checked");
    let finalPrice = basePrice;
    if (gstApplied) finalPrice += basePrice * 0.18;
    $("#roomPrice").text(finalPrice.toFixed(2));
  }

  $("#roomNumber").change(function () {
    const roomId = $(this).val();
    if (roomId) {
      $.get("{% url 'booking:get_room_details' %}", { room_id: roomId })
        .done(function (data) {
          if (!data.error) {
            $("#roomType").text(data.room_type);
            $("#acType").text(data.ac_type);
            $("#floor").text(data.floor);
            $("#status").text(data.status);
            updatePrice(data.price);
            $("#roomPrice").data('basePrice', data.price);
            $("#roomDetails").show();
          }
        })
        .fail(function () {
          alert("Failed to get room details.");
          $("#roomDetails").hide();
        });
    } else {
      $("#roomDetails").hide();
    }
  });

  $("#id_apply_gst").change(function () {
    let basePrice = $("#roomPrice").data('basePrice') || 0;
    updatePrice(basePrice);
  });
</script>
{% endblock %}
