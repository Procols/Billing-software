{% extends 'base.html' %}
{% block title %}New Booking{% endblock %}

{% block extra_head %}
<style>
main { margin-left: 220px; padding: 2rem; max-width: 760px; background:white; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.08); margin-top:1rem; margin-bottom:1rem; }
label { display:block; margin-top:15px; font-weight:600; color:#374151; }
input, select, textarea { width:100%; padding:10px; margin-top:6px; border:1px solid #d1d5db; border-radius:6px; }
button { margin-top:30px; width:100%; padding:12px; font-weight:700; border:none; border-radius:6px; cursor:pointer; background-color:#10b981; color:white; }
#roomDetails { margin-top:20px; padding:12px; border-radius:6px; background:#e0f2fe; color:#1e40af; display:none; border:1px solid #2563eb; }
</style>
{% endblock %}

{% block content %}
<h2 style="text-align:center;margin-top:0">New Booking</h2>
<main>
  <form method="POST" action="{% url 'booking:new_booking' %}">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <label>Customer Name</label> {{ form.customer_name }}
    <label>Phone Number</label> {{ form.phone_number }}
    <label>Address</label> {{ form.address }}
    <label>Document Type</label> {{ form.document_type }}
    <label>Document Number</label> {{ form.document_number }}

    <label>Room Number (Available Only)</label>
    <select id="roomNumber" name="room" required>
      <option value="">Select Room</option>
      {% for room in rooms %}
      <option value="{{ room.id }}">{{ room.room_number }} - {{ room.room_type }}</option>
      {% endfor %}
    </select>

    <div id="roomDetails">
      <strong>Room Details:</strong><br>
      Type: <span id="roomType"></span><br>
      AC Type: <span id="acType"></span><br>
      Floor: <span id="floor"></span><br>
      Status: <span id="roomStatus"></span><br>
      Price (₹): <span id="roomPrice">0.00</span><br>
      <strong>Total (with GST if applied): ₹<span id="finalPrice">0.00</span></strong>
    </div>

    <label>Adults</label> {{ form.adults }}
    <label>Children</label> {{ form.children }}
    <label>Booking Status</label> {{ form.status }}
    <label>Check-in Date & Time</label> {{ form.checkin_datetime }}
    <label>Check-out Date & Time (optional)</label> {{ form.checkout_datetime }}

    <label>Payment Type</label> {{ form.payment_type }}
    <label>Payment Status</label> {{ form.payment_status }}

    <label style="margin-top:12px;">{{ form.apply_gst }} Apply GST</label>

    <button type="submit">Save Booking</button>
  </form>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function updatePrice(basePrice, days=1) {
  const gstApplied = $("#id_apply_gst").is(":checked");
  const totalRoomPrice = basePrice * days;
  let finalPrice = totalRoomPrice;

  if (gstApplied) {
    let gstRate = (totalRoomPrice < 7000) ? 0.12 : 0.18;
    finalPrice = totalRoomPrice + (totalRoomPrice * gstRate);
  }

  $("#roomPrice").text(totalRoomPrice.toFixed(2));
  $("#finalPrice").text(finalPrice.toFixed(2));
  $("#roomPrice").data('basePrice', basePrice);
}

function calculateDays() {
  const checkin = $("#id_checkin_datetime").val();
  const checkout = $("#id_checkout_datetime").val();
  if (checkin && checkout) {
    const start = new Date(checkin);
    const end = new Date(checkout);
    let diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
    return diff > 0 ? diff : 1;
  }
  return 1;
}

$("#roomNumber").change(function () {
  const roomId = $(this).val();
  if (!roomId) { $("#roomDetails").hide(); return; }
  $.get("{% url 'booking:get_room_details' %}", {room_id: roomId})
    .done(function(data){
      $("#roomType").text(data.room_type);
      $("#acType").text(data.ac_type);
      $("#floor").text(data.floor);
      $("#roomStatus").text(data.status);
      let days = calculateDays();
      updatePrice(data.price, days);
      $("#roomDetails").show();
    }).fail(function(){ alert("Failed to fetch room details"); $("#roomDetails").hide(); });
});

$("#id_apply_gst, #id_checkin_datetime, #id_checkout_datetime").change(function(){
  let base = $("#roomPrice").data('basePrice') || 0;
  let days = calculateDays();
  updatePrice(base, days);
});
</script>
{% endblock %}
