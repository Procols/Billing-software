
{% load widget_tweaks %}

{% block title %}Booking Details{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  body {
    background-color: #f4f7fa;
    padding: 30px;
    font-family: 'Segoe UI', sans-serif;
  }
  .container {
    background: #fff;
    border-radius: 8px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    max-width: 1000px;
    margin: auto;
  }
  h2 { font-weight: 700; margin-bottom: 30px; text-align: center; color: #003366; }
  label { font-weight: 600; }
  .btn-group { display: flex; justify-content: space-between; margin-top: 30px; flex-wrap: wrap; }
  .btn-group button, .btn-group a { min-width: 100px; }
  .form-control:disabled, .form-control[readonly] { background-color: #e9ecef; }
  .section-title { margin-top: 40px; font-size: 18px; color: #00509e; font-weight: 700; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  table th, table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  table th { background-color: #f3f4f6; }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <h2>Booking Details for {{ booking.customer_name }}</h2>
  <form method="post">
    {% csrf_token %}

    <!-- Customer Info -->
    <div class="row mb-3">
      <div class="col-md-6">{{ form.customer_name.label_tag }} {{ form.customer_name|add_class:"form-control" }}</div>
      <div class="col-md-6">{{ form.phone_number.label_tag }} {{ form.phone_number|add_class:"form-control" }}</div>
    </div>

    <div class="mb-3">{{ form.address.label_tag }} {{ form.address|add_class:"form-control" }}</div>

    <div class="row mb-3">
      <div class="col-md-6">{{ form.document_type.label_tag }} {{ form.document_type|add_class:"form-control" }}</div>
      <div class="col-md-6">{{ form.document_number.label_tag }} {{ form.document_number|add_class:"form-control" }}</div>
    </div>

    <!-- Room Info -->
    <div class="row mb-3">
      <div class="col-md-4"><label>Room Type</label><input type="text" class="form-control" value="{{ booking.room.room_type }}" readonly></div>
      <div class="col-md-4"><label>Room Number</label><input type="text" class="form-control" value="{{ booking.room.room_number }}" readonly></div>
      <div class="col-md-2">{{ form.adults.label_tag }} {{ form.adults|add_class:"form-control" }}</div>
      <div class="col-md-2">{{ form.children.label_tag }} {{ form.children|add_class:"form-control" }}</div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">{{ form.status.label_tag }} {{ form.status|add_class:"form-select" }}</div>
      <div class="col-md-3">{{ form.checkin_datetime.label_tag }} {{ form.checkin_datetime|add_class:"form-control" }}</div>
      <div class="col-md-3">{{ form.checkout_datetime.label_tag }} {{ form.checkout_datetime|add_class:"form-control" }}</div>
    </div>

    <div class="row mb-3">
      <div class="col-md-3">{{ form.payment_type.label_tag }} {{ form.payment_type|add_class:"form-control" }}</div>
      <div class="col-md-3">{{ form.payment_status.label_tag }} {{ form.payment_status|add_class:"form-control" }}</div>
      <div class="col-md-3">{{ form.amount_paid.label_tag }} {{ form.amount_paid|add_class:"form-control" }}</div>
      <div class="col-md-3 d-flex align-items-center">
        <label class="mb-0 ms-2">Apply GST?</label>
        <input type="text" class="form-control" value="{{ apply_gst_display }}" readonly>
      </div>
    </div>

    <!-- Food & Drink Section -->
    <div class="section-title">Food & Drink Ordered</div>
    {% if food_details %}
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Customer Name</th>
            <th>Food</th>
            <th>Drink</th>
            <th>Price (₹)</th>
            <th>Quantity</th>
            <th>Subtotal (₹)</th>
          </tr>
        </thead>
        <tbody>
          {% for item in food_details %}
          <tr>
            {% if forloop.first %}
              <td rowspan="{{ food_details|length }}">{{ booking.customer_name }}</td>
            {% endif %}
            <td>{{ item.food_name }}</td>
            <td>{{ item.drink_name }}</td>
            <td>₹{{ item.food_price|floatformat:2 }}</td>
            <td>{{ item.quantity }}</td>
            <td>₹{{ item.subtotal|floatformat:2 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No food or drink orders.</p>
    {% endif %}

    <!-- Total summary -->
    <table class="table table-bordered mt-4" style="max-width: 400px;">
      <tbody>
        <tr><th>Total Days</th><td>{{ total_days }}</td></tr>
        <tr><th>Room Price per Day</th><td>₹{{ room_price|floatformat:2 }}</td></tr>
        <tr><th>Room Amount</th><td>₹{{ room_amount|floatformat:2 }}</td></tr>
        {% if booking.apply_gst %}
        <tr><th>CGST ({{ cgst_rate }}%)</th><td>₹{{ cgst_amount|floatformat:2 }}</td></tr>
        <tr><th>SGST ({{ sgst_rate }}%)</th><td>₹{{ sgst_amount|floatformat:2 }}</td></tr>
        {% endif %}
        <tr><th>Food & Drink Amount</th><td>₹{{ total_food_amount|floatformat:2 }}</td></tr>
        <tr><th>Total Amount</th><td>₹{{ grand_total|floatformat:2 }}</td></tr>
        <tr><th>Amount Paid</th><td>₹{{ amount_paid|floatformat:2 }}</td></tr>
        <tr><th>Balance Due</th><td><strong>₹{{ balance_due|floatformat:2 }}</strong></td></tr>
      </tbody>
    </table>

    <!-- Buttons -->
    <div class="btn-group">
      <a href="{% url 'checkin_checkout:checkin_checkout' %}" class="btn btn-secondary">← Back</a>
      <button type="submit" class="btn btn-success">Update</button>
      <a href="{% url 'checkin_checkout:invoice' booking.id %}" target="_blank" class="btn btn-primary">Print Invoice</a>
    </div>
  </form>
</div>
{% endblock %}
